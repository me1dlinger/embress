<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>文件重命名</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="{{url_for('static', filename='js/vue.js')}} "></script>
  <link rel="stylesheet" href=" {{ url_for('static', filename='css/styles.css') }} " />
</head>

<body>
  <div id="app">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
      <div class="container app-container">
        <a class="navbar-brand" href="#">
          <i class="bi bi-hdd-stack"></i>文件重命名
        </a>
        <div class="navbar-nav ms-auto" id="auth-status">
          <span v-if="isAuthenticated" class="navbar-text text-success">
            <i class="bi bi-check-circle"></i> 已验证
          </span>
          <span v-else class="auth-status unauthenticated">未认证</span>
        </div>
      </div>
    </nav>

    <!-- 认证表单 -->
    <div v-if="!isAuthenticated" class="container app-container" id="auth-container">
      <div class="auth-container">
        <div class="auth-form-container animated">
          <div class="card auth-card">
            <div class="auth-card-header">
              <h4><i class="bi bi-shield-lock me-2"></i>访问验证</h4>
            </div>
            <div class="auth-card-body">
              <form @submit.prevent="authenticate">
                <div class="mb-4">
                  <label for="access-key" class="form-label fw-medium">访问密钥</label>
                  <input type="password" class="form-control" id="access-key" v-model="accessKey" required
                    autocomplete="off" placeholder="请输入您的访问密钥" />
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg" :disabled="authLoading">
                  <span v-if="authLoading" class="spinner-border spinner-border-sm" role="status"></span>
                  <span class="btn-text"></span>
                  [[ authLoading ? '验证中...' : '验证' ]]
                  </span>
                </button>
              </form>
              <div v-if="authError" class="alert alert-danger mt-3 py-2 border-0">
                <i class="bi bi-exclamation-circle me-2"></i>
                <span> [[ authError ]] </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 主内容区域 -->
    <div v-if="isAuthenticated" class="container-fluid app-container" id="main-content">
      <div class="row mt-4">
        <div class="col-12">
          <!-- 选项卡导航 -->
          <ul class="nav nav-tabs" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'dashboard' }" @click="activeTab = 'dashboard'"
                type="button" role="tab">
                <i class="bi bi-speedometer2 me-2"></i> 仪表板
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'history' }" @click="activeTab = 'history'"
                type="button" role="tab">
                <i class="bi bi-clock-history me-2"></i> 扫描历史
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'records' }" @click="activeTab = 'records'"
                type="button" role="tab">
                <i class="bi bi-list-ul me-2"></i> 变更记录
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'logs' }" @click="activeTab = 'logs'"
                type="button" role="tab">
                <i class="bi bi-file-text me-2"></i> 日志查看
              </button>
            </li>
          </ul>

          <!-- 选项卡内容 -->
          <div class="tab-content mt-4">
            <!-- 仪表板 -->
            <div v-show="activeTab === 'dashboard'" class="tab-pane fade show active">
              <div class="row mt-4">
                <div class="col-lg-8">
                  <div class="dashboard-card status-card">
                    <div class="card-header d-flex align-items-center">
                      <i class="bi bi-info-circle me-2"></i>
                      <span>系统状态</span>
                      <button class="btn btn-sm btn-outline-primary ms-auto" @click="loadSystemStatus">
                        <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                      </button>
                    </div>
                    <div class="card-body">
                      <div v-if="statusLoading" class="d-flex justify-content-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">加载中...</span>
                        </div>
                      </div>
                      <div v-else-if="systemStatus">
                        <div class="row">
                          <div class="col-6"><strong>媒体路径:</strong></div>
                          <div class="col-6">
                            [[ systemStatus.media_path ]]
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-6"><strong>扫描间隔:</strong></div>
                          <div class="col-6">
                            [[ systemStatus.scan_interval ]] 秒
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-6">
                            <strong>调度器状态:</strong>
                          </div>
                          <div class="col-6">
                            <span class="badge" :class="systemStatus.scheduler_running ? 'bg-success' : 'bg-danger'">
                              [[ systemStatus.scheduler_running ? '运行中' :
                              '已停止' ]]
                            </span>
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-6">
                            <strong>总扫描次数:</strong>
                          </div>
                          <div class="col-6">
                            [[ systemStatus.total_scans ]]
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-4">
                  <div class="dashboard-card">
                    <div class="card-header d-flex align-items-center">
                      <i class="bi bi-gear me-2"></i>
                      <span>操作面板</span>
                    </div>
                    <div class="card-body">
                      <button class="btn btn-success w-100 mb-3" @click="performManualScan" :disabled="scanLoading">
                        <span v-if="scanLoading" class="spinner-border spinner-border-sm" role="status"></span>
                        <i v-else class="bi bi-search me-2"></i>
                        [[ scanLoading ? '扫描中...' : '手动全部扫描' ]]
                      </button>
                      <button class="btn btn-info w-100 mb-3" @click="showSubPathModal = true">

                        <span style="color: white;"><i class="bi bi-folder2-open me-2"></i>指定路径扫描</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex align-items-center">
                      <i class="bi bi-clock me-2"></i>
                      <span>最近扫描结果</span>
                    </div>
                    <div class="card-body p-4">
                      <div v-if="!lastScanResult"
                        class="d-flex flex-column align-items-center justify-content-center py-5">
                        <i class="bi bi-clock-history mb-3" style="font-size: 2.5rem; color: #ddd"></i>
                        <p class="text-muted">暂无扫描结果</p>
                      </div>
                      <div v-else>
                        <div class="alert"
                          :class="lastScanResult.status === 'error' ? 'alert-danger' : 'alert-success'">
                          <h6>
                            <i class="bi"
                              :class="lastScanResult.status === 'error' ? 'bi-x-circle' : 'bi-check-circle'"></i>
                            [[ lastScanResult.status === 'error' ? '扫描失败'
                            : '扫描完成' ]]
                          </h6>
                          <p class="mb-2">
                            <strong>时间:</strong> [[
                            formatDate(lastScanResult.timestamp) ]]
                          </p>
                          <div v-if="lastScanResult.status !== 'error'">
                            <p class="mb-2">
                              <strong>处理文件:</strong> [[
                              lastScanResult.processed ]]
                            </p>
                            <p class="mb-0">
                              <strong>重命名文件:</strong> [[
                              lastScanResult.renamed ]]
                            </p>
                          </div>
                          <div v-else>
                            <p class="mb-0">
                              <strong>错误信息:</strong> [[
                              lastScanResult.message ]]
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 扫描历史 -->
            <div :class="['tab-pane', 'fade', { show: activeTab==='history', active: activeTab==='history' }]"
              v-show="activeTab==='history'">
              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-clock-history me-2"></i>
                        <span>扫描历史</span>
                      </div>
                      <button class="btn btn-sm btn-outline-primary" @click="loadHistory">
                        <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                      </button>
                    </div>
                    <div class="card-body">
                      <div v-if="historyLoading" class="d-flex justify-content-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">加载中...</span>
                        </div>
                      </div>
                      <div v-else-if="history.length === 0">
                        <p class="text-muted">暂无扫描历史</p>
                      </div>
                      <div v-else class="row">
                        <div v-for="(record, index) in history" :key="index" class="col-md-6 mb-3">
                          <div class="card" :class="record.status === 'error' ? 'border-danger' : 'border-success'">
                            <div class="card-header"
                              :class="record.status === 'error' ? 'bg-danger text-black' : 'bg-success text-black'">
                              <h6 class="card-title mb-0">
                                <i class="bi"
                                  :class="record.status === 'error' ? 'bi-x-circle' : 'bi-check-circle'"></i>
                                扫描 # [[ history.length - index ]]
                              </h6>
                            </div>
                            <div class="card-body">
                              <p>
                                <strong>时间:</strong> [[
                                formatDate(record.timestamp) ]]
                              </p>
                              <div v-if="record.status !== 'error'">
                                <p>
                                  <strong>目录:</strong> [[ record.target
                                  ]]
                                </p>
                                <p>
                                  <strong>处理:</strong> [[ record.processed
                                  ]] 个文件
                                </p>
                                <p>
                                  <strong>重命名:</strong> [[ record.renamed
                                  ]] 个文件
                                </p>

                              </div>
                              <div v-else>
                                <p>
                                  <strong>错误:</strong> [[ record.message ]]
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 变更记录 -->
            <div :class="['tab-pane', 'fade', { show: activeTab==='records', active: activeTab==='records' }]"
              v-show="activeTab==='records'">
              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-list-ul me-2"></i>
                        <span>文件变更记录</span>
                      </div>
                      <button class="btn btn-sm btn-outline-primary" @click="loadChangeRecords">
                        <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                      </button>
                    </div>
                    <div class="card-body">
                      <div v-if="recordsLoading" class="d-flex justify-content-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">加载中...</span>
                        </div>
                      </div>
                      <div v-else-if="changeRecords.length === 0">
                        <p class="text-muted">暂无变更记录</p>
                      </div>
                      <div v-else>
                        <div v-for="(record, index) in changeRecords" :key="index" class="record-item mb-3"
                          :class="{ failed: record.status !== 'success' }">
                          <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                              <h6 class="mb-1">
                                <i class="bi"
                                  :class="record.status === 'success' ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'"></i>
                                [[ record.type === 'rename' ? '文件重命名' :
                                '字幕重命名' ]]
                              </h6>
                              <p class="mb-1">
                                <strong>节目:</strong> [[ record.show ]] / [[
                                record.season ]]
                              </p>
                              <p class="mb-1">
                                <strong>原文件名:</strong>
                                <code> [[ record.original ]] </code>
                              </p>
                              <p class="mb-1">
                                <strong>新文件名:</strong>
                                <code> [[ record.new ]] </code>
                              </p>
                              <p v-if="record.error" class="mb-1 text-danger">
                                <strong>错误:</strong> [[ record.error ]]
                              </p>
                            </div>
                            <small class="text-muted">
                              [[ formatDate(record.timestamp) ]]
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 日志查看 -->
            <div :class="['tab-pane', 'fade', { show: activeTab==='logs', active: activeTab==='logs' }]"
              v-show="activeTab==='logs'">
              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-file-text me-2"></i>
                        <span>日志文件</span>
                      </div>
                      <button class="btn btn-sm btn-outline-primary" @click="loadLogFiles">
                        <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                      </button>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-4">
                          <div class="list-group log-files-list">
                            <div v-if="logsLoading" class="d-flex justify-content-center p-4">
                              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            </div>
                            <div v-else-if="logFiles.length === 0" class="p-3 text-muted">
                              暂无日志文件
                            </div>
                            <a v-else v-for="log in logFiles" :key="log.name" href="#"
                              class="list-group-item list-group-item-action"
                              :class="{ active: selectedLogFile === log.name }"
                              @click.prevent="loadLogContent(log.name)">
                              <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">[[ log.name ]]</h6>
                                <small>
                                  [[ (log.size / 1024).toFixed(1) ]] KB</small>
                              </div>
                              <small class="text-muted">
                                [[ formatDate(log.modified) ]]
                              </small>
                            </a>
                          </div>
                        </div>
                        <div class="col-md-8">
                          <div class="log-content rounded p-3">
                            <div v-if="logContentLoading" class="text-center p-3">
                              <div class="spinner-border" role="status"></div>
                            </div>
                            <div v-else-if="!selectedLogFile">
                              <p class="text-muted">请选择日志文件查看内容</p>
                            </div>
                            <div v-else-if="logContentError" class="alert alert-danger">
                              [[ logContentError ]]
                            </div>
                            <pre v-else> [[ logContent ]] </pre>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <transition name="fade">
      <div v-if="showSubPathModal" class="modal-overlay" @click.self="closeSubPathModal"
        @keydown.esc="closeSubPathModal"
        tabindex="0"
        >
        <div class="modal-content-custom animated">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-folder2-open me-2"></i> 指定路径扫描
            </h5>
            <button type="button" class="btn-close" @click="closeSubPathModal"></button>
          </div>

          <div class="modal-body">
            <label class="form-label fw-medium mb-2">子路径</label>
            <input type="text" class="form-control" v-model="subPath" placeholder="例如：Anime/葬送的芙莉莲/Season 01"
              autocomplete="off" />
          </div>

          <div class="modal-footer">
            <!-- <button class="btn btn-secondary" @click="closeSubPathModal">取消</button> -->
            <button class="btn btn-primary" @click="performSubScan" :disabled="subScanLoading">
              <span v-if="subScanLoading" class="spinner-border spinner-border-sm"></span>
              <span v-else>扫描</span>
            </button>
          </div>
        </div>
      </div>
    </transition>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src=" {{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>