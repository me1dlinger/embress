<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/logo-slim.svg') }} ">
  <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='img/logo-slim.svg') }} ">
  <title>文件重命名</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.8/vue.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
</head>

<body>
  <div id="app">
    <nav class="navbar navbar-expand-lg">
      <div class="container app-container">
        <a class="navbar-brand" href="#">
          <i class="bi bi-hdd-stack"></i>文件重命名
        </a>
        <div class="navbar-nav ms-auto" id="auth-status">
          <span v-if="isAuthenticated" class="navbar-text text-success">
            <i class="bi bi-check-circle"></i> 已验证
          </span>
          <span v-else class="auth-status unauthenticated">未认证</span>
        </div>
      </div>
    </nav>
    <div v-if="!isAuthenticated" class="container app-container" id="auth-container">
      <div class="auth-container">
        <div class="auth-form-container animated">
          <div class="card auth-card">
            <div class="auth-card-header">
              <h4><i class="bi bi-shield-lock me-2"></i>访问验证</h4>
            </div>
            <div class="auth-card-body">
              <form @submit.prevent="authenticate">
                <div class="mb-4">
                  <label for="access-key" class="form-label fw-medium">访问密钥</label>
                  <input type="password" class="form-control" id="access-key" v-model="accessKey" required
                    autocomplete="off" placeholder="请输入您的访问密钥" />
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg" :disabled="authLoading">
                  <span v-if="authLoading" class="spinner-border spinner-border-sm" role="status"></span>
                  <span class="btn-text"></span>
                  [[ authLoading ? '验证中...' : '验证' ]]
                  </span>
                </button>
              </form>
              <div v-if="authError" class="alert alert-danger mt-3 py-2 border-0">
                <i class="bi bi-exclamation-circle me-2"></i>
                <span> [[ authError ]] </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div v-if="isAuthenticated" class="container-fluid app-container" id="main-content">
      <div class="row mt-4">
        <div class="col-12">
          <!-- 选项卡导航 -->
          <ul class="nav nav-tabs" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'dashboard' }" @click="activeTab = 'dashboard'"
                type="button" role="tab">
                <i class="bi bi-speedometer2 me-2"></i> 仪表板
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'history' }" @click="activeTab = 'history'"
                type="button" role="tab">
                <i class="bi bi-clock-history me-2"></i> 扫描历史
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'records' }" @click="activeTab = 'records'"
                type="button" role="tab">
                <i class="bi bi-list-ul me-2"></i> 变更记录
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" :class="{ active: activeTab === 'logs' }" @click="activeTab = 'logs'"
                type="button" role="tab">
                <i class="bi bi-file-text me-2"></i> 日志查看
              </button>
            </li>
          </ul>

          <!-- 选项卡内容 -->
          <div class="tab-content mt-4">
            <!-- 仪表板 -->
            <div v-show="activeTab === 'dashboard'" class="tab-pane fade show active">
              <div class="row mt-4">
                <div class="col-lg-7">
                  <div class="dashboard-card status-card">
                    <div class="card-header d-flex align-items-center">
                      <i class="bi bi-info-circle me-2"></i>
                      <span>系统状态</span>
                      <button class="btn btn-sm btn-outline-primary ms-auto" @click="loadSystemStatus">
                        <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                      </button>
                    </div>
                    <div class="card-body">
                      <div v-if="statusLoading" class="d-flex justify-content-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">加载中...</span>
                        </div>
                      </div>
                      <div v-else-if="systemStatus">
                        <div class="row">
                          <div class="col-6"><strong>媒体路径:</strong></div>
                          <div class="col-6">
                            [[ systemStatus.media_path ]]
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-6"><strong>白名单数量:</strong></div>
                          <div class="col-6">
                            <span class="badge bg-info" @click="showWhitelist">
                              [[ systemStatus.total_whitelist ]]
                            </span>

                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-6">
                            <strong>调度器状态:</strong>
                          </div>
                          <div class="col-6">
                            <span class="badge" :class="systemStatus.scheduler_running ? 'bg-success' : 'bg-danger'">
                              [[ systemStatus.scheduler_running ? '运行中' :
                              '已停止' ]]
                            </span>
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-6"><strong>扫描间隔:</strong></div>
                          <div class="col-6">
                            [[ systemStatus.scan_interval ]] 秒
                          </div>
                        </div>
                        <div class="row mt-2">
                          <div class="col-6"><strong>下次扫描:</strong></div>
                          <div class="col-6">
                            [[ systemStatus.next_scan_time ]]
                          </div>
                        </div>

                        <div class="row mt-2">
                          <div class="col-6">
                            <strong>总扫描次数:</strong>
                          </div>
                          <div class="col-6">
                            [[ systemStatus.total_scans ]]
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-5">
                  <div class="dashboard-card action-card">
                    <div class="card-header d-flex align-items-center">
                      <i class="bi bi-gear me-2"></i>
                      <span>操作面板</span>
                    </div>
                    <div class="card-body">
                      <div class="row mt-2">
                        <div class="col-6">
                          <button class="btn w-100 mb-3" style="background-color: #4285F4;" @click="performManualScan"
                            :disabled="scanLoading">

                            <span style="color: white;">
                              <span v-if="scanLoading" class="spinner-border spinner-border-sm" role="status">

                              </span><i v-else class="bi bi-search me-2"></i>
                              [[ scanLoading ? '扫描中...' : '全部扫描' ]]</span>
                          </button>
                        </div>
                        <div class="col-6">
                          <button class="btn w-100 mb-3" style="background-color: #34A853;"
                            @click="showSubPathModal = true">

                            <span style="color: white;"><i class="bi bi-folder2-open me-2"></i>指定扫描</span>
                          </button>

                        </div>

                      </div>
                      <div class="row mt-2">
                        <div class="col-6">
                          <button class="btn w-100 mb-3" style="background-color: #9B59B6;" @click="showRegexConfig">
                            <span style="color: white;"><i class="bi bi-gear me-2"></i>正则配置</span>
                          </button>
                        </div>
                        <div class="col-6">
                          <button class="btn w-100 mb-3" style="background-color: #F39C12;"
                            @click="showSubPathRollbackModal = true">
                            <span style="color: white;"><i class="bi bi-signpost me-2"></i>指定还原</span>
                          </button>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>

              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex align-items-center">
                      <i class="bi bi-clock me-2"></i>
                      <span>最新处理结果</span>
                    </div>
                    <div class="card-body p-4">
                      <div v-if="!lastScanResult"
                        class="d-flex flex-column align-items-center justify-content-center py-5">
                        <i class="bi bi-clock-history mb-3" style="font-size: 2.5rem; color: #ddd"></i>
                        <p class="text-muted">暂无扫描结果</p>
                      </div>
                      <div v-else>
                        <div class="alert"
                          :class="lastScanResult.status === 'error' ? 'alert-danger' : 'alert-success'">
                          <h6>
                            <i class="bi"
                              :class="lastScanResult.status === 'error' ? 'bi-x-circle' : 'bi-check-circle'"></i>
                            [[ lastScanResult.status === 'error' ? '扫描失败'
                            : lastScanResult.scan_type=='rollback'?'回滚完成':'扫描完成' ]]
                          </h6>
                          <p class="mb-2">
                            <strong>时间:</strong> [[
                            formatDate(lastScanResult.timestamp) ]]
                          </p>
                          <div v-if="lastScanResult.status !== 'error'">
                            <p class="mb-2">
                              <strong>处理文件:</strong> [[
                              lastScanResult.processed ]]
                            </p>
                            <div v-if="lastScanResult.deleted_nfo" class="d-flex align-items-center mb-2">
                              <strong class="me-2">删除:</strong>
                              <span>[[ lastScanResult.deleted_nfo ]] 个nfo文件</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                              <strong class="me-2">重命名:</strong>
                              <span>[[ lastScanResult.renamed?lastScanResult.renamed:0 ]] 个视频 | [[
                                lastScanResult.renamed_subtitle?lastScanResult.renamed_subtitle:0 ]] 个字幕 | [[
                                lastScanResult.renamed_audio?lastScanResult.renamed_audio:0 ]] 个音频 | [[
                                lastScanResult.renamed_picture?lastScanResult.renamed_picture:0 ]] 张图片</span>
                              <span v-if="lastScanResult.unrenamed_count > 0" class="ms-3">
                                <span class="badge bg-warning text-dark me-2">
                                  <i class="bi bi-exclamation-triangle me-1"></i>
                                  [[ lastScanResult.unrenamed_count ]] 个未重命名
                                </span>
                                <button class="btn btn-sm btn-outline-warning"
                                  @click="showUnrenamedFiles(lastScanResult.unrenamed_files)">
                                  <i class="bi bi-eye me-1"></i>查看
                                </button>
                              </span>
                            </div>
                          </div>
                          <div v-else>
                            <p class="mb-0">
                              <strong>错误信息:</strong> [[
                              lastScanResult.message ]]
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 扫描历史 -->
            <div :class="['tab-pane', 'fade', { show: activeTab==='history', active: activeTab==='history' }]"
              v-show="activeTab==='history'">
              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-clock-history me-2"></i>
                        <span>扫描历史</span>
                      </div>
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" :class="{ active: showFilteredOnly }"
                          @click="toggleFilter">
                          <i class="bi bi-funnel me-1"></i>
                          [[showFilteredOnly ? '显示全部' : '仅显示有效操作']]
                        </button>
                        <button class="btn btn-sm btn-outline-primary" @click="loadHistory">
                          <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                        </button>
                      </div>
                    </div>
                    <div class="card-body">
                      <div v-if="historyLoading" class="d-flex justify-content-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">加载中...</span>
                        </div>
                      </div>
                      <div v-else-if="history.length == 0 && !showFilteredOnly">
                        <p class="text-muted">暂无扫描历史</p>
                      </div>
                      <div v-else-if="history.length == 0 && showFilteredOnly">
                        <div class="text-center py-5">
                          <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                          <p class="text-muted mt-2">暂无有效操作记录</p>
                          <p class="text-muted small">尝试切换到显示全部记录</p>
                        </div>
                      </div>
                      <div v-else class="row">
                        <div v-for="(record, index) in history" :key="index" class="col-md-6 mb-3">
                          <div class="card" :class="record.status === 'error' ? 'border-danger' : ''">
                            <div class="card-header d-flex justify-content-between align-items-center"
                              :class="record.status === 'error' ? 'bg-danger text-white' : 'text-black'">
                              <h6 v-if="record.scan_type=='rollback'" class="card-title mb-0">
                                <i class="bi"
                                  :class="record.status === 'error' ? 'bi-x-circle' : 'bi-check-circle'"></i>
                                回滚 # [[ history.length - index ]]
                              </h6>
                              <h6 v-else class="card-title mb-0">
                                <i class="bi"
                                  :class="record.status === 'error' ? 'bi-x-circle' : 'bi-check-circle'"></i>
                                扫描 # [[ history.length - index ]]
                              </h6>
                            </div>
                            <div class="card-body">
                              <div class="row">
                                <div class="col-12 mb-2">
                                  <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>
                                    [[ formatDate(record.timestamp) ]]
                                  </small>
                                </div>
                              </div>
                              <div v-if="record.status !== 'error'">
                                <div class="row mb-2">
                                  <div class="col-12">
                                    <small class="text-muted">目录:</small>
                                    <div class="text-break">[[ record.target ]]</div>
                                  </div>
                                </div>

                                <div class="row g-2 mb-2">
                                  <div class="col-6">
                                    <div class="stat-box">
                                      <div class="stat-number">[[ record.processed ]]</div>
                                      <div class="stat-label">处理文件</div>
                                    </div>
                                  </div>
                                  <div class="col-6">
                                    <div class="stat-box">
                                      <div class="stat-number">[[ record.renamed || 0 ]]</div>
                                      <div class="stat-label">重命名视频</div>
                                    </div>
                                  </div>
                                </div>

                                <div class="rename-stats">
                                  <div class="row g-2">
                                    <div class="col-6">
                                      <div class="stat-item">
                                        <i class="bi bi-badge-cc text-info me-1"></i>
                                        <span>[[ record.renamed_subtitle || 0 ]] 字幕</span>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="stat-item">
                                        <i class="bi bi-music-note text-success me-1"></i>
                                        <span>[[ record.renamed_audio || 0 ]] 音频</span>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="stat-item">
                                        <i class="bi bi-image text-warning me-1"></i>
                                        <span>[[ record.renamed_picture || 0 ]] 图片</span>
                                      </div>
                                    </div>
                                    <div class="col-6">
                                      <div class="stat-item">
                                        <i class="bi bi-trash text-danger me-1"></i>
                                        <span>[[ record.deleted_nfo || 0 ]] NFO</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <div v-if="record.unrenamed_count > 0" class="mt-3 pt-2 border-top">
                                  <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-warning text-dark">
                                      <i class="bi bi-exclamation-triangle me-1"></i>
                                      [[ record.unrenamed_count ]] 个未重命名
                                    </span>
                                    <button class="btn btn-sm btn-outline-warning"
                                      @click="showUnrenamedFiles(record.unrenamed_files)">
                                      <i class="bi bi-eye me-1"></i>查看详情
                                    </button>
                                  </div>
                                </div>
                              </div>
                              <div v-else>
                                <div class="alert alert-danger mb-0">
                                  <i class="bi bi-exclamation-triangle me-2"></i>
                                  <strong>错误:</strong> [[ record.message ]]
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <!-- 变更记录 -->
            <div :class="['tab-pane', 'fade', { show: activeTab==='records', active: activeTab==='records' }]"
              v-show="activeTab==='records'">
              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-list-ul me-2"></i>
                        <span v-if="selectedShow.media_type">[[ selectedShow.media_type ]]/[[ selectedShow.show_name ]]
                          - 变更记录</span>
                        <span v-else>节目变更记录</span>
                      </div>
                      <div class="d-flex gap-2">
                        <button v-if="selectedShow.media_type" class="btn btn-sm btn-outline-secondary"
                          @click="goBackToShows">
                          <i class="bi bi-arrow-left me-1"></i> 返回列表
                        </button>
                        <button class="btn btn-sm btn-outline-primary" @click="loadChangeRecords">
                          <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                        </button>
                      </div>
                    </div>
                    <div class="card-body">
                      <div v-if="recordsLoading" class="d-flex justify-content-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">加载中...</span>
                        </div>
                      </div>

                      <!-- 节目列表视图 -->
                      <div v-else-if="!selectedShow.media_type">
                        <div v-if="showsChangeList.length === 0">
                          <p class="text-muted">暂无变更记录</p>
                        </div>
                        <div v-else>
                          <div v-for="show in showsChangeList" :key="show.show_name" class="show-item mb-3"
                            @click="selectShow(show.media_type,show.show_name)">
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="flex-grow-1">
                                <h6 class="mb-1 d-flex align-items-center copy-title">
                                  <i class="bi bi-tv me-2"></i>
                                  [[ show.media_type ]]/[[ show.show_name ]]
                                </h6>
                                <div class="d-flex align-items-center gap-3">
                                  <span class="badge bg-primary">[[ show.record_count ]] 条记录</span>
                                  <div class="type-badges">
                                    <span v-for="type in show.types" :key="type" class="badge bg-secondary me-1">
                                      [[ getTypeLabel(type) ]]
                                    </span>
                                  </div>
                                </div>
                              </div>
                              <div class="text-end">
                                <small class="text-muted d-block">最后更新</small>
                                <small class="text-muted">[[ formatDate(show.latest_timestamp) ]]</small>
                                <div class="mt-1">
                                  <i class="bi bi-chevron-right"
                                    @click="selectShow(show.media_type,show.show_name)"></i>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- 节目详细记录视图 -->
                      <div v-else>
                        <div v-if="selectedShowRecords.length === 0">
                          <p class="text-muted">该节目暂无变更记录</p>
                        </div>
                        <div v-else>
                          <!-- 统计信息 -->
                          <div class="statistics-section mb-4">
                            <h6 class="mb-3">
                              <i class="bi bi-bar-chart me-2"></i>
                              统计信息
                            </h6>
                            <div class="row g-3 justify-content-center">
                              <div class="col-md-2" v-for="(count, type) in recordTypeStats" :key="type">
                                <div class="stat-card text-center">
                                  <div class="stat-icon">
                                    <i :class="getTypeIcon(type)"></i>
                                  </div>
                                  <div class="stat-number">[[ count ]]</div>
                                  <div class="stat-label">[[ getTypeLabel(type) ]]</div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- 新增：分组方式选择 -->
                          <div class="grouping-section mb-4">
                            <div class="d-flex align-items-center gap-3">
                              <span class="fw-medium">分组方式：</span>
                              <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm"
                                  :class="groupBy === 'type' ? 'btn-primary' : 'btn-outline-primary'"
                                  @click="setGroupBy('type')">
                                  <i class="bi bi-tags me-1"></i>
                                  按类型分组
                                </button>
                                <button type="button" class="btn btn-sm"
                                  :class="groupBy === 'season' ? 'btn-primary' : 'btn-outline-primary'"
                                  @click="setGroupBy('season')">
                                  <i class="bi bi-collection me-1"></i>
                                  按季度分组
                                </button>
                              </div>
                            </div>
                          </div>

                          <!-- 修改：筛选控制 - 根据分组方式显示不同的筛选选项 -->
                          <div class="filter-section mb-4">
                            <div class="d-flex align-items-center gap-3">
                              <span class="fw-medium">筛选[[groupBy === 'type' ? '类型' : '季度']]: </span>
                              <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm"
                                  :class="selectedTypeFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'"
                                  @click="setTypeFilter('all')">
                                  全部 ([[ selectedShowRecords.length ]])
                                </button>
                                <template v-if="groupBy === 'type'">
                                  <button type="button" v-for="(count, type) in recordTypeStats" :key="type"
                                    class="btn btn-sm"
                                    :class="selectedTypeFilter === type ? 'btn-primary' : 'btn-outline-primary'"
                                    @click="setTypeFilter(type)">
                                    [[ getTypeLabel(type) ]] ([[ count ]])
                                  </button>
                                </template>
                                <template v-else>
                                  <button type="button" v-for="(count, season) in seasonStats" :key="season"
                                    class="btn btn-sm"
                                    :class="selectedTypeFilter === season ? 'btn-primary' : 'btn-outline-primary'"
                                    @click="setTypeFilter(season)">
                                    [[ season ]] ([[ count ]])
                                  </button>
                                </template>
                              </div>
                            </div>
                            <div class="mt-2">
                              <small class="text-muted">
                                显示 [[ filteredRecords.length ]] 条记录
                                <span v-if="selectedTypeFilter !== 'all'">
                                  - [[ groupBy === 'type' ? getTypeLabel(selectedTypeFilter) : selectedTypeFilter ]]
                                </span>
                              </small>
                            </div>
                          </div>

                          <!-- 修改：按分组方式展示记录 -->
                          <div v-if="selectedTypeFilter === 'all'">
                            <div v-for="(records, groupKey) in groupedRecords" :key="groupKey" class="type-group mb-4">
                              <div class="type-group-header">
                                <h6 class="mb-0">
                                  <i :class="groupBy === 'type' ? getTypeIcon(groupKey) : getSeasonIcon(groupKey)"
                                    class="me-2"></i>
                                  [[ groupBy === 'type' ? getTypeLabel(groupKey) : groupKey ]]
                                  <span class="badge bg-light text-dark ms-2">[[ records.length ]]</span>
                                </h6>
                              </div>
                              <div class="type-group-content">
                                <div v-for="(record, index) in records" :key="index" class="record-item mb-3"
                                  :class="{ failed: record.status !== 'success' }">
                                  <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                      <h6 class="mb-1">
                                        <span v-if="record.rollback">
                                          <i class="bi bi-arrow-counterclockwise text-warning"></i>
                                          [已回滚]
                                        </span>
                                        <i v-else class="bi"
                                          :class="record.status === 'success' ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'"></i>
                                        <span v-if="groupBy === 'season'">[[ getTypeLabel(record.type) ]] - </span>
                                        <!-- <span v-else>[[ record.show_name ]] - </span> -->
                                        [[ record.season_name ]]
                                      </h6>
                                      <div class="file-info">
                                        <div v-if="record.type === 'nfo_delete'" class="mb-1">
                                          <strong>删除文件:</strong>
                                          <code class="filename">[[ record.original ]]</code>
                                        </div>
                                        <div v-else>
                                          <div class="mb-1">
                                            <strong>原文件:</strong>
                                            <code class="filename">[[ record.original ]]</code>
                                          </div>
                                          <div class="mb-1">
                                            <strong>新文件:</strong>
                                            <code class="filename">[[ record.new ]]</code>
                                          </div>
                                          <div class="mb-1">
                                            <strong>路径:</strong>
                                            <code class="filename" @click.stop="copyText(record.relative_path)"
                                              :title="'点击复制路径:'+record.relative_path">[[ record.relative_path ]]</code>
                                          </div>
                                        </div>
                                      </div>
                                      <p v-if="record.error" class="mb-1 text-danger">
                                        <strong>错误:</strong> [[ record.error ]]
                                      </p>
                                    </div>
                                    <div class="text-end">
                                      <small class="text-muted">
                                        [[ formatDate(record.timestamp) ]]
                                      </small>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- 筛选后的记录展示保持不变 -->
                          <div v-else>
                            <div v-for="(record, index) in filteredRecords" :key="index" class="record-item mb-3"
                              :class="{ failed: record.status !== 'success' }">
                              <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                  <h6 class="mb-1">
                                    <span v-if="record.rollback">
                                      <i class="bi bi-arrow-counterclockwise text-warning"></i>
                                      [已回滚]
                                    </span>
                                    <i v-else class="bi"
                                      :class="record.status === 'success' ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'"></i>
                                    [[ record.season_name ]]
                                  </h6>
                                  <div class="file-info">
                                    <div v-if="record.type === 'nfo_delete'" class="mb-1">
                                      <strong>删除文件:</strong>
                                      <code class="filename">[[ record.original ]]</code>
                                    </div>
                                    <div v-else>
                                      <div class="mb-1">
                                        <strong>原文件:</strong>
                                        <code class="filename">[[ record.original ]]</code>
                                      </div>
                                      <div class="mb-1">
                                        <strong>新文件:</strong>
                                        <code class="filename">[[ record.new ]]</code>
                                      </div>
                                    </div>
                                  </div>
                                  <p v-if="record.error" class="mb-1 text-danger">
                                    <strong>错误:</strong> [[ record.error ]]
                                  </p>
                                </div>
                                <div class="text-end">
                                  <small class="text-muted">
                                    [[ formatDate(record.timestamp) ]]
                                  </small>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 日志查看 -->
            <div :class="['tab-pane', 'fade', { show: activeTab==='logs', active: activeTab==='logs' }]"
              v-show="activeTab==='logs'">
              <div class="row mt-4">
                <div class="col-12">
                  <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-file-text me-2"></i>
                        <span>日志文件</span>
                      </div>
                      <button class="btn btn-sm btn-outline-primary" @click="loadLogFiles">
                        <i class="bi bi-arrow-clockwise me-1"></i> 刷新
                      </button>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-4">
                          <div class="list-group log-files-list">
                            <div v-if="logsLoading" class="d-flex justify-content-center p-4">
                              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            </div>
                            <div v-else-if="logFiles.length === 0" class="p-3 text-muted">
                              暂无日志文件
                            </div>
                            <a v-else v-for="log in logFiles" :key="log.name" href="#"
                              class="list-group-item list-group-item-action"
                              :class="{ active: selectedLogFile === log.name }"
                              @click.prevent="loadLogContent(log.name)">
                              <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">[[ log.name ]]</h6>
                                <small>
                                  [[ (log.size / 1024).toFixed(1) ]] KB</small>
                              </div>
                              <small class="text-muted">
                                [[ formatDate(log.modified) ]]
                              </small>
                            </a>
                          </div>
                        </div>
                        <div class="col-md-8">
                          <div class="log-content rounded p-3">
                            <div v-if="logContentLoading" class="text-center p-3">
                              <div class="spinner-border" role="status"></div>
                            </div>
                            <div v-else-if="!selectedLogFile">
                              <p class="text-muted">请选择日志文件查看内容</p>
                            </div>
                            <div v-else-if="logContentError" class="alert alert-danger">
                              [[ logContentError ]]
                            </div>
                            <pre v-else> [[ logContent ]] </pre>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div v-if="showModal" class="custom-modal-overlay" @click.self="closeModal">
      <div class="custom-modal" :class="'modal-' + modalType" :style="{ display: showModal ? 'block' : 'none' }">
        <div class="custom-modal-header">
          <i class="modal-icon bi" :class="modalIcon"></i>
          <h5 class="modal-title">[[ modalTitle ]]</h5>
        </div>
        <div class="custom-modal-body">
          <p>[[ modalContent ]]</p>
        </div>
        <div class="custom-modal-footer">
          <button v-if="hasCancel" @click="closeModal" class="modal-btn modal-btn-secondary">取消</button>
          <button @click="confirmAction" class="modal-btn modal-btn-primary">确定</button>
        </div>
      </div>
    </div>
    <div class="toast-container">
      <div v-for="toast in toasts" :key="toast.id" class="toast-item"
        :class="['toast-' + toast.type, { 'toast-show': toast.visible }]" @click="removeToast(toast.id)">
        <div class="toast-content">
          <i class="toast-icon bi" :class="getToastIcon(toast.type)"></i>
          <div class="toast-text">
            <div class="toast-title" v-if="toast.title">[[ toast.title ]]</div>
            <div class="toast-message">[[ toast.message ]]</div>
          </div>
          <button class="toast-close" @click.stop="removeToast(toast.id)">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="toast-progress" :style="{ animationDuration: toast.duration + 'ms' }"></div>
      </div>
    </div>
    <transition name="fade">
      <div v-if="showSubPathModal" class="modal-overlay" @click.self="closeSubPathModal"
        @keydown.esc="closeSubPathModal" tabindex="0">
        <div class="modal-content-custom animated">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-folder2-open me-2"></i> 指定路径扫描
            </h5>
            <button type="button" class="btn-close" @click="closeSubPathModal"></button>
          </div>

          <div class="modal-body">
            <label class="form-label fw-medium mb-2">子路径</label>
            <input type="text" class="form-control" v-model="subPath" placeholder="例如：Anime/葬送的芙莉莲/Season 01"
              autocomplete="off" />
          </div>

          <div class="modal-footer">
            <!-- <button class="btn btn-secondary" @click="closeSubPathModal">取消</button> -->
            <button class="btn btn-primary" @click="performSubScan" :disabled="subScanLoading">
              <span v-if="subScanLoading" class="spinner-border spinner-border-sm"></span>
              <span v-else>扫描</span>
            </button>
          </div>
        </div>
      </div>
    </transition>
    <transition name="fade">
      <div v-if="showSubPathRollbackModal" class="modal-overlay" @click.self="closeSubPathRollbackModal"
        @keydown.esc="closeSubPathModal" tabindex="0">
        <div class="modal-content-custom animated">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-folder2-open me-2"></i> 指定路径还原
            </h5>
            <button type="button" class="btn-close" @click="closeSubPathRollbackModal"></button>
          </div>

          <div class="modal-body">
            <label class="form-label fw-medium mb-2">Season 路径</label>
            <input type="text" class="form-control" v-model="subPath" placeholder="例如：Anime/葬送的芙莉莲/Season 01"
              autocomplete="off" />
          </div>

          <div class="modal-footer">
            <button class="btn btn-primary" @click="performSubRollBack" :disabled="subScanLoading">
              <span v-if="subScanLoading" class="spinner-border spinner-border-sm"></span>
              <span v-else>回滚</span>
            </button>
          </div>
        </div>
      </div>
    </transition>
    <transition name="fade">
      <div v-if="showUnrenamedModal" class="modal-overlay" @click.self="closeUnrenamedModal"
        @keydown.esc="closeUnrenamedModal" tabindex="0">
        <div class="modal-content-custom animated unrenamed-modal">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-exclamation-triangle me-2 text-warning"></i> 未重命名文件列表
            </h5>
            <button type="button" class="btn-close" @click="closeUnrenamedModal"></button>
          </div>

          <div class="modal-body">
            <div v-if="unrenamedFiles.length === 0" class="text-center py-4 text-muted">
              <i class="bi bi-check-circle mb-2" style="font-size: 2rem;"></i>
              <p>暂无未重命名文件</p>
            </div>
            <div v-else>
              <p class="text-muted mb-3">
                <i class="bi bi-info-circle me-1"></i>
                共 <strong>[[ unrenamedFiles.length ]]</strong> 个文件未能重命名，您可以将这些文件添加到白名单中以跳过处理。
              </p>
              <div class="unrenamed-files-list">
                <div v-for="(file, index) in unrenamedFiles" :key="index" class="unrenamed-file-item">
                  <div class="file-info">
                    <div class="file-name">
                      <i class="bi bi-file-earmark me-2"></i>
                      <strong>[[ getFileName(file.path) ]]</strong>
                    </div>
                    <div class="file-path text-muted">
                      <i class="bi bi-folder me-1"></i>
                      [[ getDirectoryPath(file.path) ]]
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" @click="addToWhitelist(file.path)"
                    :disabled="whitelistLoading">
                    <span v-if="whitelistLoading" class="spinner-border spinner-border-sm me-1"></span>
                    <i v-else class="bi bi-plus-circle me-1"></i>
                    加入白名单
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" @click="closeUnrenamedModal">关闭</button>
          </div>
        </div>
      </div>
    </transition>
    <transition name="fade">
      <div v-if="showWhitelistModal" class="modal-overlay" @click.self="closeWhitelistModal"
        @keydown.esc="closeWhitelistModal" tabindex="0">
        <div class="modal-content-custom animated unrenamed-modal">
          <div class="modal-header">
            <h5 class="modal-title">
              白名单文件列表
            </h5>
            <button type="button" class="btn-close" @click="closeWhitelistModal"></button>
          </div>
          <div class="modal-body">
            <div class="whitelist-add-section">
              <h6 class="section-title">
                <i class="bi bi-plus-circle me-2"></i>添加白名单
              </h6>
              <div class="row mb-3">
                <div class="col-md-8">
                  <input type="text" class="form-control" v-model="newWhitelistPath" placeholder="输入文件路径或目录路径..."
                    @keyup.enter="addNewWhitelist">
                </div>
                <div class="col-md-4">
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="whitelistType" id="file-type" value="file"
                      v-model="newWhitelistType">
                    <label class="btn btn-outline-primary btn-sm" for="file-type">
                      <i class="bi bi-file-earmark me-1"></i>文件
                    </label>

                    <input type="radio" class="btn-check" name="whitelistType" id="dir-type" value="directory"
                      v-model="newWhitelistType">
                    <label class="btn btn-outline-primary btn-sm" for="dir-type">
                      <i class="bi bi-folder me-1"></i>目录
                    </label>
                  </div>
                </div>
              </div>
              <button class="btn btn-primary btn-sm mb-3" @click="addNewWhitelist" :disabled="!newWhitelistPath.trim()">
                <i class="bi bi-plus-circle me-1"></i>添加到白名单
              </button>
              <hr>
            </div>
            <div v-if="whitelistFiles.length === 0 && newWhitelistItems.length === 0"
              class="text-center py-4 text-muted">
              <i class="bi bi-check-circle mb-2" style="font-size: 2rem;"></i>
              <p>暂无白名单文件</p>
            </div>
            <div v-else>
              <p class="text-muted mb-3">
                <i class="bi bi-info-circle me-1"></i>
                共 <strong>[[ whitelistFiles.length + newWhitelistItems.length ]]</strong> 个项目在白名单中
                <span v-if="newWhitelistItems.length > 0" class="badge bg-info ms-2">
                  新增 [[ newWhitelistItems.length ]] 个
                </span>
              </p>

              <div class="whitelist-files-list">
                <div v-for="(item, index) in newWhitelistItems" :key="'new-' + index"
                  class="whitelist-file-item new-item">
                  <div class="file-info">
                    <div class="file-name">
                      <i class="bi" :class="item.type === 'directory' ? 'bi-folder-fill' : 'bi-file-earmark'" me-2></i>
                      <strong>[[ getFileName(item.path) ]]</strong>
                      <span class="badge bg-success ms-2">新增</span>
                      <span class="badge" :class="item.type === 'directory' ? 'bg-warning' : 'bg-info'" ms-1>
                        [[ item.type === 'directory' ? '目录' : '文件' ]]
                      </span>
                    </div>
                    <div class="file-path text-muted">
                      <i class="bi bi-folder me-1"></i>
                      [[ getDirectoryPath(item.path) ]]
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-danger" @click="removeNewWhitelistItem(index)">
                    <i class="bi bi-trash me-1"></i>移除
                  </button>
                </div>
                <div v-for="(file, index) in whitelistFiles" :key="'existing-' + index" class="whitelist-file-item"
                  :class="file.type === 'file' ? 'file-type' : 'directory-type'">

                  <div v-if="file.type=='file'" class="file-info">
                    <div class="file-name">
                      <i class="bi bi-file-earmark me-2"></i>
                      <strong>[[ getFileName(file.path) ]]</strong>
                    </div>
                    <div class="file-path text-muted">
                      <i class="bi bi-folder me-1"></i>
                      [[ getDirectoryPath(file.path) ]]
                    </div>
                  </div>
                  <div v-else class="file-info">
                    <div class="file-name">
                      <i class="bi bi-file-earmark me-2"></i>
                      <strong>[[ file.path ]]</strong>
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" @click="deleteFromWhitelist(file.path)"
                    :disabled="deleteFromWhitelistLoading">
                    <span v-if="deleteFromWhitelistLoading" class="spinner-border spinner-border-sm me-1"></span>
                    <i v-else class="bi bi-trash me-1"></i>
                    移出白名单
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" @click="closeWhitelistModal">关闭</button>
            <button v-if="newWhitelistItems.length > 0" class="btn btn-success" style="margin-left: 20px;"
              @click="submitNewWhitelistItems" :disabled="submitWhitelistLoading">
              <span v-if="submitWhitelistLoading" class="spinner-border spinner-border-sm me-1"></span>
              <i v-else class="bi bi-check-circle me-1"></i>
              提交新增项目 ([[ newWhitelistItems.length ]])
            </button>
          </div>
        </div>
      </div>
    </transition>
    <transition name="fade">
      <div v-if="showRegexModal" class="modal-overlay regex-modal" @click.self="closeRegexModal"
        @keydown.esc="closeRegexModal" tabindex="0">
        <div class="modal-content-custom animated">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-code-slash me-2"></i> 正则表达式配置
            </h5>
            <button type="button" class="btn-close" @click="closeRegexModal"></button>
          </div>

          <div class="modal-body">
            <div v-if="regexLoading" class="d-flex justify-content-center py-4">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
            <div v-else>
              <div class="row">
                <div class="col-md-6">
                  <div class="regex-section">
                    <div class="regex-section-header">
                      <h6 class="regex-section-title">
                        <i class="bi bi-123 me-2"></i> 集数模式正则表达式
                      </h6>
                      <button type="button" class="btn btn-sm btn-outline-primary"
                        @click="addRegexItem('episode_only')">
                        <i class="bi bi-plus-circle me-1"></i> 添加
                      </button>
                    </div>
                    <p class="form-text mb-3">用于识别只包含集数的文件名格式，如 第01话</p>

                    <div class="regex-list">
                      <div v-for="(pattern, index) in regexPatterns.episode_only" :key="index" class="regex-item">
                        <input type="text" class="form-control regex-input" v-model="regexPatterns.episode_only[index]"
                          placeholder="例如: $$(\d{1,3})$$">
                        <div class="regex-actions">
                          <button class="btn btn-outline-danger btn-sm" type="button"
                            @click="removeRegexItem('episode_only', index)" title="删除">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>

                      <div v-if="regexPatterns.episode_only.length === 0" class="regex-empty">
                        <i class="bi bi-inbox"></i>
                        <p>暂无正则表达式</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="regex-section">
                    <div class="regex-section-header">
                      <h6 class="regex-section-title">
                        <i class="bi bi-collection me-2"></i> 季集模式正则表达式
                      </h6>
                      <button type="button" class="btn btn-sm btn-outline-primary"
                        @click="addRegexItem('season_episode')">
                        <i class="bi bi-plus-circle me-1"></i> 添加
                      </button>
                    </div>
                    <p class="form-text mb-3">用于识别包含季数和集数的文件名格式，如 S01E01</p>

                    <div class="regex-list">
                      <div v-for="(pattern, index) in regexPatterns.season_episode" :key="index" class="regex-item">
                        <input type="text" class="form-control regex-input"
                          v-model="regexPatterns.season_episode[index]" placeholder="例如: [Ss](\d{1,2})[Ee](\d{1,3})">
                        <div class="regex-actions">
                          <button class="btn btn-outline-danger btn-sm" type="button"
                            @click="removeRegexItem('season_episode', index)" title="删除">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>

                      <div v-if="regexPatterns.season_episode.length === 0" class="regex-empty">
                        <i class="bi bi-inbox"></i>
                        <p>暂无正则表达式</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="regexError" class="alert alert-danger mt-3 py-2">
                <i class="bi bi-exclamation-circle me-2"></i>
                [[ regexError ]]
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-primary" @click="saveRegexPatterns" :disabled="regexSaving || regexLoading">
              <span v-if="regexSaving" class="spinner-border spinner-border-sm me-2"></span>
              <i v-else class="bi bi-check-circle me-2"></i>
              [[ regexSaving ? '保存中...' : '保存配置' ]]
            </button>
          </div>
        </div>
      </div>
    </transition>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>